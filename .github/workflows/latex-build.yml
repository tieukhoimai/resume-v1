name: Build CV (LuaLaTeX)

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      use_tinytex:
        description: 'Install TinyTeX instead of apt texlive'
        required: false
        default: 'false'
      publish_release:
        description: 'Publish the built PDF to a GitHub Release'
        required: false
        default: 'false'
      release_tag:
        description: 'Tag name to use for the Release (optional)'
        required: false
      release_name:
        description: 'Release name (optional)'
        required: false

jobs:
  build:
    name: Build example/cv.pdf
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install TeX dependencies (apt-get)
        if: ${{ github.event.inputs.use_tinytex != 'true' }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            latexmk texlive-latex-recommended texlive-latex-extra texlive-luatex texlive-xetex texlive-fonts-recommended texlive-fonts-extra texlive-bibtex-extra biber fonts-font-awesome lmodern texlive-lang-french texlive-pictures

      - name: Install TinyTeX (alternative)
        if: ${{ github.event.inputs.use_tinytex == 'true' }}
        run: |
          curl -sL 'https://yihui.org/tinytex/install-bin-unix.sh' | sh -s - -y
          echo "$HOME/bin" >> $GITHUB_PATH
          tlmgr update --self
          tlmgr install latexmk biber collection-latexrecommended collection-latexextra collection-luatex collection-langfrench collection-fontsrecommended fontawesome5 csquotes

      - name: Build the example CV with LuaLaTeX
        working-directory: ./example
        run: latexmk -cd -f -lualatex -interaction=nonstopmode -synctex=1 cv.tex

      - name: Upload PDF artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cv.pdf
          path: example/cv.pdf

  release:
    name: Publish CV as Release
    runs-on: ubuntu-latest
    needs: build
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true') || startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release (if needed)
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '' && github.event.inputs.release_tag || startsWith(github.ref, 'refs/tags/') && replace(github.ref, 'refs/tags/', '') || 'cv-build' }}
          release_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_name != '' && github.event.inputs.release_name || 'CV build' }}
          draft: false
          prerelease: false

      - name: Upload built PDF to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./example/cv.pdf
          asset_name: cv.pdf
          asset_content_type: application/pdf
